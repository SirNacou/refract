{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://short.link/schemas/click-event-v1.json",
  "title": "Click Event",
  "description": "Schema for click events published from Redirector service to Analytics Processor via Redis Streams. Events are captured on every redirect and contain anonymized visitor data for analytics.",
  "type": "object",
  "required": [
    "event_id",
    "url_id",
    "timestamp",
    "user_agent",
    "ip_address"
  ],
  "properties": {
    "event_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique event identifier (UUIDv4)",
      "examples": ["550e8400-e29b-41d4-a716-446655440000"]
    },
    "url_id": {
      "type": "integer",
      "format": "int64",
      "description": "Snowflake ID of the short URL (foreign key to urls.snowflake_id)",
      "minimum": 1,
      "examples": [1234567890123456]
    },
    "short_code": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9-]{3,50}$",
      "description": "Short code used in the redirect (Base62 or custom alias, for logging/debugging)",
      "minLength": 3,
      "maxLength": 50,
      "examples": ["dBvJIX9uyO", "my-blog"]
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Event timestamp (ISO 8601 format, UTC timezone)",
      "examples": ["2026-01-09T12:34:56.789Z"]
    },
    "user_agent": {
      "type": "string",
      "maxLength": 500,
      "description": "Full HTTP User-Agent header (parsed for device/browser/OS)",
      "examples": ["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"]
    },
    "ip_address": {
      "type": "string",
      "format": "ipv4",
      "description": "Anonymized IPv4 address (last octet zeroed for privacy, e.g., 192.168.1.100 -> 192.168.1.0)",
      "pattern": "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$",
      "examples": ["192.168.1.0", "203.0.113.0"]
    },
    "ip_address_v6": {
      "type": "string",
      "format": "ipv6",
      "description": "Anonymized IPv6 address (last 80 bits zeroed for privacy). Only present if request used IPv6.",
      "examples": ["2001:db8:85a3::"]
    },
    "referrer": {
      "type": "string",
      "format": "uri",
      "maxLength": 2048,
      "description": "HTTP Referer header (source URL that linked to short URL). Null if direct visit or referrer blocked.",
      "examples": ["https://google.com/search?q=example", "https://twitter.com/status/123456", null]
    },
    "country_code": {
      "type": "string",
      "pattern": "^[A-Z]{2}$",
      "description": "ISO 3166-1 alpha-2 country code (derived from IP via MaxMind GeoLite2). Null if GeoIP lookup fails.",
      "examples": ["US", "GB", "JP", null]
    },
    "country_name": {
      "type": "string",
      "maxLength": 100,
      "description": "Full country name (English). Null if GeoIP lookup fails.",
      "examples": ["United States", "United Kingdom", "Japan", null]
    },
    "city": {
      "type": "string",
      "maxLength": 100,
      "description": "City name (English, derived from GeoIP). Null if GeoIP lookup fails or city unavailable.",
      "examples": ["New York", "London", "Tokyo", null]
    },
    "latitude": {
      "type": "number",
      "format": "double",
      "minimum": -90,
      "maximum": 90,
      "description": "Geographic latitude (derived from GeoIP). Null if unavailable.",
      "examples": [40.7128, 51.5074, 35.6762, null]
    },
    "longitude": {
      "type": "number",
      "format": "double",
      "minimum": -180,
      "maximum": 180,
      "description": "Geographic longitude (derived from GeoIP). Null if unavailable.",
      "examples": [-74.0060, -0.1278, 139.6503, null]
    },
    "device_type": {
      "type": "string",
      "enum": ["desktop", "mobile", "tablet", "bot", "unknown"],
      "description": "Device type (parsed from user agent). Defaults to 'unknown' if parsing fails.",
      "examples": ["desktop", "mobile", "tablet"]
    },
    "browser": {
      "type": "string",
      "maxLength": 100,
      "description": "Browser name and version (parsed from user agent). Null if parsing fails.",
      "examples": ["Chrome 120.0", "Safari 17.2", "Firefox 121.0", null]
    },
    "operating_system": {
      "type": "string",
      "maxLength": 100,
      "description": "Operating system name and version (parsed from user agent). Null if parsing fails.",
      "examples": ["Windows 10", "macOS 14.2", "iOS 17.2", "Android 14", null]
    },
    "cache_tier": {
      "type": "string",
      "enum": ["l1", "l2", "db"],
      "description": "Cache tier that served the redirect (l1=in-memory, l2=Redis, db=PostgreSQL fallback). Used for performance monitoring.",
      "examples": ["l1", "l2"]
    },
    "latency_ms": {
      "type": "number",
      "format": "double",
      "minimum": 0,
      "description": "Redirect latency in milliseconds (from request received to response sent). Used for performance monitoring.",
      "examples": [3.4, 12.7, 45.2]
    },
    "request_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique request ID for distributed tracing (correlates with logs)",
      "examples": ["a3bb189e-8bf9-3888-9912-ace4e6543002"]
    }
  },
  "additionalProperties": false,
  "x-redis-stream": {
    "stream_key": "refract:click_events",
    "consumer_group": "analytics-processor",
    "batch_size": 100,
    "flush_interval_ms": 1000,
    "max_length": 1000000,
    "max_length_approximate": true,
    "max_latency_seconds": 5
  },
  "examples": [
    {
      "event_id": "550e8400-e29b-41d4-a716-446655440000",
      "url_id": 1234567890123456,
      "short_code": "dBvJIX9uyO",
      "timestamp": "2026-01-09T12:34:56.789Z",
      "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
      "ip_address": "192.168.1.0",
      "referrer": "https://google.com/search?q=example",
      "country_code": "US",
      "country_name": "United States",
      "city": "New York",
      "latitude": 40.7128,
      "longitude": -74.0060,
      "device_type": "desktop",
      "browser": "Chrome 120.0",
      "operating_system": "Windows 10",
      "cache_tier": "l1",
      "latency_ms": 3.4,
      "request_id": "a3bb189e-8bf9-3888-9912-ace4e6543002"
    },
    {
      "event_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "url_id": 9876543210987654,
      "short_code": "my-blog",
      "timestamp": "2026-01-09T14:22:10.123Z",
      "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Mobile/15E148 Safari/604.1",
      "ip_address": "203.0.113.0",
      "referrer": "https://twitter.com/status/123456",
      "country_code": "JP",
      "country_name": "Japan",
      "city": "Tokyo",
      "latitude": 35.6762,
      "longitude": 139.6503,
      "device_type": "mobile",
      "browser": "Safari 17.2",
      "operating_system": "iOS 17.2",
      "cache_tier": "l2",
      "latency_ms": 12.7,
      "request_id": "b5aa341c-9de3-4222-8712-bfe5f7654321"
    },
    {
      "event_id": "d290f1ee-6c54-4b01-90e6-d701748f0851",
      "url_id": 5555555555555555,
      "short_code": "abc123",
      "timestamp": "2026-01-09T16:45:33.456Z",
      "user_agent": "curl/7.68.0",
      "ip_address": "198.51.100.0",
      "referrer": null,
      "country_code": null,
      "country_name": null,
      "city": null,
      "latitude": null,
      "longitude": null,
      "device_type": "bot",
      "browser": null,
      "operating_system": null,
      "cache_tier": "db",
      "latency_ms": 45.2,
      "request_id": "c3dd452f-1af5-5333-9823-cfe6e8765432"
    }
  ],
  "$comment": "Redis Stream Configuration: Stream key 'click_events', consumer group 'analytics_processor', batch size 100 events per read, max latency 5 seconds (FR-024)"
}
