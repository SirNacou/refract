# Refract

A high-performance URL shortener built with Go and PostgreSQL.

## Architecture

Refract is designed as a multi-service monorepo:

- **services/api** - REST API for URL management (CRUD operations)
- **services/redirector** - Fast redirect service (future)
- **services/click-worker** - Click analytics worker (future)

### Tech Stack

- **Language**: Go 1.25
- **Database**: PostgreSQL 16
- **Migrations**: Goose
- **Container**: Docker + Docker Compose
- **Task Runner**: Just

## Features

- URL shortening with custom or auto-generated codes
- Auto-generated short codes using Sqids (bit-shuffling algorithm)
- 12-month expiry with auto-renewal on click
- JSONB metadata for extensibility
- Partial indexes for high performance
- Auto-updating timestamps
- Support for custom vanity URLs (future)

## Getting Started

### Prerequisites

- Docker and Docker Compose
- Just (task runner) - [Installation](https://github.com/casey/just#installation)
- Go 1.25+ (for local development)

### Quick Start

1. **Clone the repository**
   ```bash
   git clone <your-repo-url>
   cd refract
   ```

2. **Copy environment file**
   ```bash
   cp .env.example .env
   ```
   
   Edit `.env` and update values as needed (default values work for local development).

3. **Start services**
   ```bash
   just up
   ```

   This will:
   - Start PostgreSQL container
   - Run database migrations automatically
   - Start the API service

4. **Check service status**
   ```bash
   just status
   ```

5. **View logs**
   ```bash
   just logs          # All services
   just api-logs      # API only
   just postgres-logs # PostgreSQL only
   ```

### Available Commands

Run `just` to see all available commands:

```bash
just                  # List all commands
just up               # Start all services
just down             # Stop all services
just rebuild          # Rebuild and restart
just clean            # Remove all data (DESTRUCTIVE)
just logs             # View all logs
just api-logs         # View API logs
just db-shell         # Connect to PostgreSQL
just migrate-status   # Check migration status
just migrate-create   # Create new migration
just test             # Run tests
just fmt              # Format Go code
```

## Project Structure

```
refract/
├── .env                           # Environment variables (gitignored)
├── .env.example                   # Environment template
├── docker-compose.yml             # Service orchestration
├── justfile                       # Task definitions
├── migrations/                    # Database migrations
│   └── postgres/
│       └── 00001_create_urls_table.sql
└── services/
    ├── api/                       # API Service
    │   ├── cmd/api/main.go       # Entry point
    │   ├── internal/
    │   │   ├── config/           # Configuration
    │   │   ├── database/         # Database connection
    │   │   ├── handlers/         # HTTP handlers
    │   │   ├── models/           # Data models
    │   │   └── repository/       # Database operations
    │   ├── Dockerfile
    │   └── go.mod
    ├── redirector/                # Redirector Service (future)
    └── click-worker/              # Analytics Worker (future)
```

## Database Schema

### URLs Table

```sql
CREATE TABLE urls (
    id BIGINT PRIMARY KEY,  -- Snowflake ID (generated by application)
    short_code VARCHAR(20) UNIQUE NOT NULL,
    original_url TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (CURRENT_TIMESTAMP + INTERVAL '12 months') NOT NULL,
    click_count BIGINT DEFAULT 0 NOT NULL,
    is_active BOOLEAN DEFAULT true NOT NULL,
    metadata JSONB DEFAULT '{}'::jsonb NOT NULL
);
```

**Features:**
- Snowflake IDs for distributed ID generation (time-ordered, no DB dependency)
- Auto-expiry after 12 months (renewable on click)
- JSONB metadata for custom parameters (UTM, QR settings, etc.)
- Partial indexes for optimal query performance
- Auto-updating `updated_at` via database trigger

## Development

### Running Migrations

Migrations run automatically on `just up`. For manual control:

```bash
# Check migration status
just migrate-status

# Run migrations manually
just migrate-up

# Create new migration
just migrate-create add_users_table
```

### Local Development (without Docker)

1. **Install dependencies**
   ```bash
   cd services/api
   go mod download
   ```

2. **Set environment variables**
   ```bash
   export DB_HOST=localhost
   export DB_PORT=5432
   export DB_USER=postgres
   export DB_PASSWORD=postgres
   export DB_NAME=refract
   export DB_SSLMODE=disable
   export PORT=8080
   ```

3. **Run migrations**
   ```bash
   goose -dir ../../migrations/postgres postgres "host=localhost port=5432 user=postgres password=postgres dbname=refract sslmode=disable" up
   ```

4. **Run the API**
   ```bash
   go run cmd/api/main.go
   ```

### Testing

```bash
just test  # Run all tests
```

### Code Formatting

```bash
just fmt   # Format Go code
just lint  # Run linter (requires golangci-lint)
```

## Configuration

Environment variables are loaded from `.env` file. See `.env.example` for all available options.

### Key Configuration Options

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_HOST` | PostgreSQL host | `postgres` |
| `DB_PORT` | PostgreSQL port | `5432` |
| `DB_USER` | Database user | `postgres` |
| `DB_PASSWORD` | Database password | `postgres` |
| `DB_NAME` | Database name | `refract` |
| `API_PORT` | API service port | `8080` |
| `SQIDS_ALPHABET` | Characters for short codes | `a-zA-Z0-9` |
| `SQIDS_MIN_LENGTH` | Minimum short code length | `6` |

## Migration Strategy

Refract uses a **dedicated migration container** that runs once before services start:

1. PostgreSQL starts with health checks
2. Migration container runs Goose migrations
3. Migration container exits after completion
4. API service starts (depends on successful migration)

This ensures:
- Migrations run exactly once
- All services use the latest schema
- Clean separation of concerns
- Production-ready deployment pattern

## Authentication

Authentication will be handled by [Zitadel](https://zitadel.com/) (planned feature).

## Roadmap

- [ ] HTTP handlers for URL CRUD operations
- [ ] Sqids integration for auto-generated short codes
- [ ] Redirector service (high-performance redirect with caching)
- [ ] Click analytics worker (async click tracking)
- [ ] Zitadel authentication integration
- [ ] Custom domain support
- [ ] QR code generation
- [ ] Analytics dashboard

## License

[Your License Here]
